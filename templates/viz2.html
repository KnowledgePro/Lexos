{% extends "base.html" %}
{% set active_page = 'viz' %}
{% set is_analysis = True %}

{% block head %}
<script type="text/javascript" src="{{ url_for('static', filename='jquery.multiselect.min.js') }}"></script>
<!--<script type="text/javascript" src="{{ url_for('static', filename='scripts_viz.js') }}"></script>-->
<script>
// Can be transferred to scripts_viz.js
$(function() {

	// Spinner Functionality
	$( "#minlength" ).spinner({
		step: 1,
		min: 0
	});
	$( "#graphsize" ).spinner({
		step: 10,
		min: 100,
		max: 3000
	});
	
	// Multiselect Dropdown Functionality
	$("#segmentlist").multiselect({
		noneSelectedText: "Select Segments",
		selectedText: "# of # checked"	
	});

    // Ensure that the default pointer is used
    $('.container').css('cursor', 'default');

});
</script>
<link href="{{ url_for('static', filename='jquery.multiselect.css') }}" rel="stylesheet">
<style>
.bubbletip {
  position: absolute;
  display: block;
  z-index: 10000;
  border: 2px solid black;
  background-color: rgba(0,0,0,0.8);
  margin: auto;
  padding: 3px 5px 3px 5px;
  color: white;
  font-size: 12px;
  font-family: arial;
  border-radius: 5px;
  vertical-align: middle;
  text-align: center;
  min-width: 50px;
  overflow: auto;
  box-shadow: 0 0 7px black;
}
</style>
{% endblock %}

{% block title %}analyzer{% endblock %}

{% block formstart %}
<form id="viz" action="" method="POST" enctype="multipart/form-data">
{% endblock %}


{% block field %}

<legend>BubbleViz Options</legend>
<div id="vizoptionsbox">
	<div id="vizcreateoptions">
		
		<div style="float: left; margin-right: 20px;">
			<select id="segmentlist" name="segmentlist" multiple="multiple" style="width: 300px;">
				{% for item in segments %}
				<option value="{{ item }}" {{ 'selected' if item in request.form.getlist('segmentlist') }}>{{ item }}</option>
				{% endfor %}
			</select>
			<br />
			Large graphs can take a while to render.
		</div>

	</div>

	<div style="float: left; margin-right: 20px;">
		<label for="minlength">Minimum Word Length:
		<input id="minlength" name="minlength" value="{{ request.form['minlength'] if request.form['minlength'] else '0' }}" style="width:30px;" />
		<!-- <input type="hidden" id="ml" name="ml" value="{{ request.form['minlength'] if request.form['minlength'] else '0' }}" /> -->
		</label>
	</div>

	<div style="float: left; margin-right: 20px;">
		<label for="graphsize">Graph Size:
		<input id="graphsize" name="graphsize" value="{{ request.form['graphsize'] if request.form['graphsize'] else '800' }}" style="width:40px;" />
		<!-- <input type="hidden" id="gs" name="gs" value="{{ request.form['graphsize'] if request.form['graphsize'] else '800' }}" /> -->
		</label>
	</div>

</div>

{% endblock %}

{% block content %}
<script>
$(function() {

// Append tooltip div to body
var tooltip = d3.select("body")
	.append("div")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden")
     .attr("class", "bubbletip")
     .text("Default");

// Load the dataset
var dataset = 
{
    "name": "tokens",
    "children": [
        {% for key, value in wordDict.iteritems() %}{"name": "{{ key|e }}", "size": {{ value|e }}},{% endfor %}
    ]
};

// Configure the graph
var diameter = {{ graphsize }},
    format = d3.format(",d"),
    color = d3.scale.category20c();

var bubble = d3.layout.pack()
    .sort(null)
    .size([diameter, diameter])
    .padding(1.5);

// Append the SVG
var svg = d3.select(".container").append("svg")
    .attr("width", diameter)
    .attr("height", diameter)
    .attr("class", "bubble");

// Append the nodes
var node = svg.selectAll(".node")
      .data(bubble.nodes(classes(dataset))
      .filter(function(d) { return !d.children; }))
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

// Append the bubbles
node.append("circle")
      .attr("r", function(d) { return d.r; })
      .style("fill",function(d,i){return color(d.className);}) // Use packageName for clustered data
      .on("mouseover", function(d) {
	     d3.select(this).style("fill", "gold");
          tooltip.html(d.className+"<br />"+d.value);
          tooltip.style("visibility", "visible");
	  })
	  .on("mousemove", function(d,i) {
          tooltip.style("top", (event.pageY-35)+"px").style("left",(event.pageX+10)+"px");
	  })	
	  .on("mouseout", function() {
		d3.select(this).style("fill", function(d,i) { return color(d.className); });
          tooltip.style("visibility", "hidden");
	   });

// Append the labels
node.append("text")
      .attr("dy", ".3em")
      .style("text-anchor", "middle")
      .text(function(d) { return d.className.substring(0, d.r / 3); })
      .on("mouseover", function(d) {
          d3.select(this.parentNode.childNodes[0]).style("fill", "gold");
          tooltip.html(d.className+"<br />"+d.value);
          tooltip.style("visibility", "visible");
	  })
	  .on("mousemove", function(d,i) {
          tooltip.style("top", (event.pageY-35)+"px").style("left",(event.pageX+10)+"px");
	  })	
	  .on("mouseout", function() {
          d3.select(this.parentNode.childNodes[0]).style("fill", function(d,i) { return color(d.className); });
          tooltip.style("visibility", "hidden");
	  });

// Return a flattened hierarchy containing all leaf nodes under the root.
function classes(root) {
  var classes = [];

  function recurse(name, node) {
    if (node.children) node.children.forEach(function(child) { recurse(node.name, child); });
    else classes.push({packageName: name, className: node.name, value: node.size});
  }

  recurse(null, root);
  return {children: classes};
}

// Set the graph height from the diameter
d3.select(self.frameElement).style("height", diameter + "px");
});
</script>

{% endblock %}


{% block submit %}
<input class="bttn bttn-action" id="getviz" type="submit" value="Get Graph"/>
{% endblock %}